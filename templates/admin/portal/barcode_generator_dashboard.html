{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}Barcode Generator Dashboard{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .barcode-dashboard {
            margin: 20px;
        }
        
        .barcode-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .products-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .products-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .barcode-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .barcode-preview {
            max-width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        
        .no-products {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .no-products h3 {
            color: #28a745;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
    </style>
{% endblock %}

{% block content %}
<div class="barcode-dashboard">
    <h1>üìä Barcode Generator Dashboard</h1>
    
    <!-- Stats Cards -->
    <div class="barcode-stats">
        <div class="stat-card">
            <div class="stat-number">{{ total_products_without_barcode }}</div>
            <div class="stat-label">Products Without Barcodes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ categories.count }}</div>
            <div class="stat-label">Total Categories</div>
        </div>
    </div>
    
    {% if products_without_barcode %}
    <!-- Actions -->
    <div class="barcode-actions">
        <button type="button" class="btn btn-primary" onclick="selectAll()">
            üìã Select All
        </button>
        <button type="button" class="btn btn-primary" onclick="deselectAll()">
            üö´ Deselect All
        </button>
        <button type="button" class="btn btn-success" onclick="generateSelected()">
            üè∑Ô∏è Generate Barcodes for Selected
        </button>
        <button type="button" class="btn btn-info" onclick="printSelected()">
            üñ®Ô∏è Print Labels for Selected
        </button>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
        <h3>üîç Filter Products</h3>
        <select id="categoryFilter" onchange="filterByCategory()">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- Products Table -->
    <div class="products-table">
        <form id="barcodeForm" method="post" action="{% url 'admin:generate_bulk_barcodes' %}">
            {% csrf_token %}
            <table>
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAll()">
                        </th>
                        <th>Product Name & Price</th>
                        <th>Category</th>
                        <th>SKU</th>
                        <th>Current Barcode</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products_without_barcode %}
                    <tr class="product-row" data-category="{{ product.category.id }}">
                        <td>
                            <input type="checkbox" name="selected_products" value="{{ product.id }}" class="product-checkbox">
                        </td>
                        <td>
                            <strong>{{ product.name }}</strong>
                            <br>
                            <small style="color: #6c757d;">ID: {{ product.id }}</small>
                            <br>
                            <small style="color: #28a745; font-weight: bold;">QAR {{ product.unit_price|floatformat:2 }}</small>
                        </td>
                        <td>
                            <span class="badge" style="background: #e9ecef; color: #495057; padding: 3px 8px; border-radius: 3px;">
                                {{ product.category.name }}
                            </span>
                        </td>
                        <td>
                            {% if product.sku %}
                                <code>{{ product.sku }}</code>
                            {% else %}
                                <span style="color: #dc3545;">No SKU</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if product.barcode %}
                                <code>{{ product.barcode }}</code>
                            {% else %}
                                <span style="color: #dc3545;">No Barcode</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" onclick="generateSingle({{ product.id }})">
                                üè∑Ô∏è Generate
                            </button>
                            {% if product.barcode %}
                            <button type="button" class="btn btn-info btn-sm" onclick="previewBarcode({{ product.id }})">
                                üëÅÔ∏è Preview
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
    
    {% else %}
    <div class="no-products">
        <h3>üéâ Great! All products have barcodes!</h3>
        <p>All your products already have barcodes assigned. No action needed.</p>
        <a href="{% url 'admin:portal_product_changelist' %}" class="btn btn-primary">
            üì¶ Manage Products
        </a>
    </div>
    {% endif %}
    
    <!-- Loading indicator -->
    <div id="loading" class="loading">
        <h3>‚è≥ Generating barcodes...</h3>
        <p>Please wait while we generate barcodes for your products.</p>
    </div>
</div>

<!-- Barcode Preview Modal -->
<div id="barcodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; margin: 50px auto; max-width: 500px; padding: 20px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>üìã Barcode Preview</h3>
            <button onclick="closeBarcodeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="barcodeModalContent"></div>
    </div>
</div>

<script>
function selectAll() {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    checkboxes.forEach(cb => cb.checked = true);
    selectAllCheckbox.checked = true;
    
    console.log(`‚úÖ Selected all ${checkboxes.length} products`);
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    checkboxes.forEach(cb => cb.checked = false);
    selectAllCheckbox.checked = false;
    
    console.log('‚úÖ Deselected all products');
}

function toggleAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const isChecked = selectAllCheckbox.checked;
    const checkboxes = document.querySelectorAll('.product-checkbox');
    
    checkboxes.forEach(cb => cb.checked = isChecked);
    
    const action = isChecked ? 'Selected' : 'Deselected';
    console.log(`‚úÖ ${action} all ${checkboxes.length} products`);
}

function filterByCategory() {
    const categoryId = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('.product-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (!categoryId || row.dataset.category === categoryId) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    console.log(`‚úÖ Filtered products: ${visibleCount} visible`);
    updateSelectionCount();
}

function updateSelectionCount() {
    const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
    const totalCheckboxes = document.querySelectorAll('.product-checkbox');
    const visibleCheckboxes = Array.from(totalCheckboxes).filter(cb => 
        cb.closest('.product-row').style.display !== 'none'
    );
    
    console.log(`üìä Selection: ${selectedCheckboxes.length} selected out of ${visibleCheckboxes.length} visible products`);
}

// Add event listeners for checkboxes to update count
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionCount);
    });
    
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            setTimeout(updateSelectionCount, 50); // Small delay to ensure DOM is updated
        });
    }
});

function generateSelected() {
    const selected = document.querySelectorAll('.product-checkbox:checked');
    
    // Validate selection
    if (selected.length === 0) {
        alert('‚ùå Please select at least one product to generate barcodes');
        return;
    }
    
    // Confirm action
    if (!confirm(`üè∑Ô∏è Generate barcodes for ${selected.length} selected product(s)?`)) {
        return;
    }
    
    try {
        // Show loading indicator
        document.getElementById('loading').classList.add('show');
        
        // Submit form
        document.getElementById('barcodeForm').submit();
        
    } catch (error) {
        console.error('Error in generateSelected:', error);
        document.getElementById('loading').classList.remove('show');
        alert(`‚ùå Error submitting barcode generation: ${error.message}`);
    }
}

function generateSingle(productId) {
    // Validate product ID
    if (!productId || isNaN(productId)) {
        alert('‚ùå Invalid product ID');
        return;
    }
    
    // Confirm action
    if (!confirm('üè∑Ô∏è Generate barcode for this product?')) {
        return;
    }
    
    try {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            throw new Error('CSRF token not found');
        }
        
        // Make API call
        fetch(`/admin/barcode/generate-single/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken.value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Barcode generated successfully: ${data.barcode_number}`);
                location.reload();
            } else {
                alert(`‚ùå Error: ${data.error || 'Unknown error occurred'}`);
            }
        })
        .catch(error => {
            console.error('Error generating barcode:', error);
            alert(`‚ùå Error generating barcode: ${error.message}`);
        });
        
    } catch (error) {
        console.error('Error in generateSingle:', error);
        alert(`‚ùå Error: ${error.message}`);
    }
}

function previewBarcode(productId) {
    // Validate product ID
    if (!productId || isNaN(productId)) {
        alert('‚ùå Invalid product ID');
        return;
    }
    
    try {
        // Make API call to preview barcode
        fetch(`/admin/barcode/preview/${productId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Display barcode preview in modal
                    document.getElementById('barcodeModalContent').innerHTML = `
                        <div style="text-align: center;">
                            <h4>üì¶ ${data.product_name}</h4>
                            <p><strong>Category:</strong> ${data.category}</p>
                            <p><strong>Barcode:</strong> <code>${data.barcode_number}</code></p>
                            <img src="data:image/png;base64,${data.image_base64}" 
                                 class="barcode-preview" 
                                 alt="Barcode Preview"
                                 style="max-width: 100%; height: auto;">
                        </div>
                    `;
                    document.getElementById('barcodeModal').style.display = 'block';
                } else {
                    alert(`‚ùå Error: ${data.error || 'Unable to preview barcode'}`);
                }
            })
            .catch(error => {
                console.error('Error previewing barcode:', error);
                alert(`‚ùå Error previewing barcode: ${error.message}`);
            });
            
    } catch (error) {
        console.error('Error in previewBarcode:', error);
        alert(`‚ùå Error: ${error.message}`);
    }
}

function closeBarcodeModal() {
    document.getElementById('barcodeModal').style.display = 'none';
}

function printSelected() {
    const selected = document.querySelectorAll('.product-checkbox:checked');
    
    // Validate selection
    if (selected.length === 0) {
        alert('‚ùå Please select at least one product to print labels');
        return;
    }
    
    // Confirm action
    if (!confirm(`üñ®Ô∏è Print barcode labels for ${selected.length} selected product(s)?`)) {
        return;
    }
    
    try {
        // Extract product IDs and validate they exist
        const productIds = Array.from(selected).map(cb => {
            const id = cb.value;
            if (!id || isNaN(id)) {
                throw new Error(`Invalid product ID: ${id}`);
            }
            return id;
        });
        
        // Build URL with proper encoding
        const params = productIds.map(id => `products=${encodeURIComponent(id)}`).join('&');
        const url = `/admin/barcode/print-labels/?${params}`;
        
        // Show loading feedback
        console.log(`üñ®Ô∏è Printing labels for products: ${productIds.join(', ')}`);
        
        // Open in new tab/window
        const printWindow = window.open(url, '_blank', 'width=800,height=600,scrollbars=yes');
        
        // Check if popup was blocked
        if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
            alert('‚ùå Popup blocked! Please allow popups for this site to print labels.');
            return;
        }
        
        // Optional: Show success message after a delay
        setTimeout(() => {
            console.log('‚úÖ Label printing window opened successfully');
        }, 500);
        
    } catch (error) {
        console.error('Error in printSelected:', error);
        alert(`‚ùå Error preparing labels for printing: ${error.message}`);
    }
}

// Close modal when clicking outside
document.getElementById('barcodeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBarcodeModal();
    }
});
</script>
{% endblock %}
