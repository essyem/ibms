<!-- templates/portal/barcode_scanner.html -->
{% extends 'portal/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Barcode Scanner</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <video id="barcode-scanner" width="100%" style="border: 1px solid #ddd;"></video>
                    <button id="start-scan" class="btn btn-primary mt-2">Start Scanner</button>
                    <button id="stop-scan" class="btn btn-danger mt-2" disabled>Stop Scanner</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Or Enter Barcode Manually</h5>
                    <div class="input-group mb-3">
                        <input type="text" id="manual-barcode" class="form-control" placeholder="Enter barcode">
                        <button id="manual-submit" class="btn btn-secondary">Submit</button>
                    </div>
                    
                    <div id="product-result" class="mt-3">
                        <!-- Product info will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include the barcode scanning library -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scannerVideo = document.getElementById('barcode-scanner');
    const startBtn = document.getElementById('start-scan');
    const stopBtn = document.getElementById('stop-scan');
    const manualBarcode = document.getElementById('manual-barcode');
    const manualSubmit = document.getElementById('manual-submit');
    const productResult = document.getElementById('product-result');
    
    let scannerActive = false;
    
    // Start barcode scanner
    startBtn.addEventListener('click', function() {
        scannerActive = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: scannerVideo,
                constraints: {
                    width: 480,
                    height: 320,
                    facingMode: "environment"
                },
            },
            decoder: {
                readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "upc_e_reader"]
            },
        }, function(err) {
            if (err) {
                console.error(err);
                alert("Error initializing barcode scanner: " + err);
                return;
            }
            Quagga.start();
        });
        
        Quagga.onDetected(function(result) {
            if (!scannerActive) return;
            
            const code = result.codeResult.code;
            fetchProduct(code);
        });
    });
    
    // Stop barcode scanner
    stopBtn.addEventListener('click', function() {
        scannerActive = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        Quagga.stop();
    });
    
    // Manual barcode submission
    manualSubmit.addEventListener('click', function() {
        const code = manualBarcode.value.trim();
        if (code) {
            fetchProduct(code);
        }
    });
    
    // Function to fetch product data
    function fetchProduct(barcode) {
        productResult.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        
        fetch('/api/barcode-scan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `barcode=${encodeURIComponent(barcode)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                productResult.innerHTML = `
                    <div class="alert alert-danger">
                        ${data.error}
                    </div>
                `;
            } else {
                const product = data.product;
                productResult.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>${product.name}</h5>
                            <p>SKU: ${product.sku}</p>
                            <p>Price: $${product.price}</p>
                            ${product.image_url ? `<img src="${product.image_url}" class="img-fluid" style="max-height: 150px;">` : ''}
                            <button class="btn btn-success mt-2 add-to-cart" data-product-id="${product.id}">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            productResult.innerHTML = `
                <div class="alert alert-danger">
                    Error fetching product: ${error}
                </div>
            `;
        });
    }
    
    // Handle adding to cart (you'll need to implement this)
    productResult.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-to-cart')) {
            const productId = e.target.getAttribute('data-product-id');
            // Implement your cart addition logic here
            alert(`Product ${productId} added to cart!`);
        }
    });
});
</script>
{% endblock %}