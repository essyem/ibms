
{% extends "portal/invoice_base.html" %}
{% load static %}

{% block title %}Create Invoice - Trendz Portal{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg" style="background: rgba(255,255,255,0.95); border: none; border-radius: 15px;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0;">
                    <h2 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        {% if object %}Edit{% else %}Create{% endif %} Invoice
                    </h2>
                </div>
                <div class="card-body p-4">

    {% if form.errors %}
    <div class="alert alert-danger">
        <strong>Error!</strong> Please correct the errors below.
    </div>
    {% endif %} 

    {% if messages %}
    <div class="alert alert-info">
        {% for message in messages %}
        <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %} 
    
    <form method="post" id="invoice-form">
        {% csrf_token %}
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Customer Details</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="customer">Customer Name</label>
                            <div class="input-group">
                                <select class="form-control" name="customer" id="customer" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" {% if object and object.customer.id == customer.id %}selected{% endif %}>
                                        {{ customer.company_name|default:customer.full_name }} ({{ customer.custom_id }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="add-customer-btn" title="Add New Customer">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address">Delivery Address</label>
                            <textarea class="form-control" name="address" id="address" rows="1" required>
                                {% if object %}{{ object.address }}{% endif %}
                            </textarea>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="text" class="form-control" name="phone" id="phone" value="{% if object %}{{ object.customer.phone }}{% endif %}" required>
                        </div>
                        <div class="form-group">
                            <label for="tax_number">Tax Number</label>
                            <input type="text" class="form-control" name="tax_number" id="tax_number" value="{% if object %}{{ object.customer.tax_number }}{% endif %}">
                        </div>
                    </div>
                </div>
            </div>  
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Invoice Details</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" class="form-control" name="date" id="date" value="{% if object %}{{ object.date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}" required>
                        </div>
                        <div class="form-group">
                            <label for="due_date">Due Date</label>
                            <input type="date" class="form-control" name="due_date" id="due_date" value="{% if object %}{{ object.due_date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}" required>
                        </div>
                        <div class="form-group">
                            <label for="invoice_number">Invoice Number</label>
                            <input type="text" class="form-control" name="invoice_number" id="invoice_number" value="{% if object %}{{ object.invoice_number }}{% else %}Auto-generated{% endif %}" {% if object %}readonly{% endif %}>
                        </div>  
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select class="form-control" name="status" id="status">
                                <option value="draft" {% if object and object.status == 'draft' %}selected{% endif %}>Draft</option>
                                <option value="sent" {% if object and object.status == 'sent' %}selected{% endif %}>Sent</option>
                                <option value="paid" {% if object and object.status == 'paid' %}selected{% endif %}>Paid</option>
                                <option value="cancelled" {% if object and object.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>  
        <!-- Products Section -->
        <div class="card mb-4">
            <div class="card-header">Products</div>
            <div class="card-body">
                <table class="table" id="products-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="product-rows">
                        <!-- Product rows will be added here -->
                    </tbody>
                </table>
                
                <button type="button" class="btn btn-primary" id="add-product">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
        </div>
        
        
        <!-- Product Row Template -->
        <template id="product-row-template">
            <tr class="product-row">
                <td>
                    <div class="product-search-container">
                        <div class="search-controls">
                            <input type="text" 
                                   class="form-control product-search-input" 
                                   placeholder="Search products by name, barcode, or category..."
                                   style="margin-bottom: 5px;">
                            <button type="button" 
                                    class="btn btn-sm btn-primary barcode-scan-btn">
                                📷 Scan Barcode
                            </button>
                        </div>
                        <div class="search-results" style="display: none;"></div>
                        <select class="form-control product-select" name="products">
                            <option value="">Select a product...</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" 
                                    data-selling-price="{{ product.unit_price }}" 
                                    data-unit-price="{{ product.unit_price }}"
                                    data-stock="{{ product.stock }}"
                                    data-barcode="{{ product.barcode }}">
                                {{ product.name }} - QAR {{ product.unit_price }} (Stock: {{ product.stock }})
                            </option>
                            {% endfor %}
                        </select>
                        <div class="selected-product-info" style="display: none;">
                            <div class="product-details"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="number" class="form-control quantity" name="quantity" value="1" min="1" step="1" required>
                </td>
                <td>
                    <input type="text" class="form-control unit-price" name="unit_price" value="0.00" readonly>
                </td>
                <td>
                    <input type="text" class="form-control total" name="total" value="0.00" readonly>
                </td>
                <td>
                    <button type="button" class="btn btn-danger remove-product">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        </template>
        <!-- Invoice Summary and Payment Details (Side by Side) -->
        <div class="row mb-4">
            <!-- Invoice Summary Column -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Invoice Summary</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 form-group mb-3">
                        <label class="form-label">Invoice Number:</label>
                        <input type="text" class="form-control bg-light" value="{{ invoice_number|default:'Auto-generated' }}" readonly>
                    </div>
                    <div class="col-md-6 form-group mb-3">
                        <label class="form-label">Subtotal:</label>
                        <input type="text" class="form-control" id="subtotal" value="0.00" readonly>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <label class="form-label">Tax:</label>
                    <input type="number" class="form-control" id="tax" value="0.00" step="0.01" min="0">
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group mb-3">
                        <label class="form-label">Discount Type:</label>
                        <select class="form-select" id="discount-type">
                            <option value="percent">Percentage</option>
                            <option value="amount">Fixed Amount</option>
                        </select>
                    </div>
                    <div class="col-md-6 form-group mb-3">
                        <label class="form-label">Discount Value:</label>
                        <input type="number" class="form-control" id="discount-value" value="0.00" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <label class="form-label">Discount Amount:</label>
                    <input type="text" class="form-control" id="discount-amount" value="0.00" readonly>
                </div>
                
                <div class="form-group mb-3">
                    <label class="form-label">Grand Total:</label>
                    <input type="text" class="form-control" id="grand-total" value="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Details Column -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Payment Details</div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label class="form-label">Payment Mode</label>
                    <select class="form-select" name="payment_mode" required id="payment-mode-select">
                        <option value="">Select Payment Method</option>
                        {% for value, name in form.fields.payment_mode.choices %}
                            <option value="{{ value }}" {% if form.payment_mode.value == value %}selected{% endif %}>
                                {{ name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="split-details" class="{% if form.data.payment_mode != 'split' %}d-none{% endif %}">
                    <div class="row">
                        <div class="col-md-6 form-group mb-3">
                            <label class="form-label">Cash Amount</label>
                            {{ form.cash_amount }}
                        </div>
                        <div class="col-md-6 form-group mb-3">
                            <label class="form-label">POS Amount</label>
                            {{ form.pos_amount }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 form-group mb-3">
                            <label class="form-label">Other Amount</label>
                            {{ form.other_amount }}
                        </div>
                        <div class="col-md-6 form-group mb-3">
                            <label class="form-label">Other Method</label>
                            {{ form.other_method }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Messages -->
        <div id="form-messages" class="alert d-none mt-3"></div>
        
        <!-- Form Actions -->
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="submit" class="btn btn-success">Save Invoice</button>
                <a href="{% url 'portal:invoice_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
</div>

{% endblock %}
{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Simple working Invoice Script - Restored
$(document).ready(function() {
    console.log('🚀 Simple Invoice Script Starting...');
    
    // Add Product functionality - Simple and working
    $('#add-product').on('click', function() {
        console.log('🖱️ Add Product clicked');
        
        var template = document.getElementById('product-row-template');
        if (!template) {
            console.error('❌ Template not found');
            return;
        }
        
        var clone = template.content.cloneNode(true);
        var productRows = document.getElementById('product-rows');
        if (productRows) {
            productRows.appendChild(clone);
            console.log('✅ Product row added successfully');
            updateTotals();
        }
    });
    
    // Handle product selection
    $(document).on('change', '.product-select', function() {
        var $select = $(this);
        var $row = $select.closest('tr');
        var selectedOption = $select.find('option:selected');
        
        if (selectedOption.val()) {
            var unitPrice = selectedOption.data('selling-price') || selectedOption.data('unit-price') || 0;
            $row.find('.unit-price').val(unitPrice);
            calculateRowTotal($row[0]);
        }
    });
    
    // Handle quantity changes
    $(document).on('input', '.quantity', function() {
        var $row = $(this).closest('tr');
        calculateRowTotal($row[0]);
    });
    
    // Remove product row
    $(document).on('click', '.remove-product', function() {
        $(this).closest('tr').remove();
        updateTotals();
    });
    
    // Calculate row total
    function calculateRowTotal(row) {
        var quantity = parseFloat($(row).find('.quantity').val()) || 0;
        var unitPrice = parseFloat($(row).find('.unit-price').val()) || 0;
        var total = quantity * unitPrice;
        
        $(row).find('.total').val(total.toFixed(2));
        updateTotals();
    }
    
    // Update grand totals
    function updateTotals() {
        var subtotal = 0;
        $('.total').each(function() {
            subtotal += parseFloat($(this).val()) || 0;
        });
        
        var tax = parseFloat($('#tax').val()) || 0;
        var discountValue = parseFloat($('#discount-value').val()) || 0;
        var discountType = $('#discount-type').val();
        
        var discountAmount = 0;
        if (discountType === 'percent') {
            discountAmount = subtotal * (discountValue / 100);
        } else {
            discountAmount = discountValue;
        }
        
        var grandTotal = subtotal + tax - discountAmount;
        
        $('#subtotal').val(subtotal.toFixed(2));
        $('#discount-amount').val(discountAmount.toFixed(2));
        $('#grand-total').val(grandTotal.toFixed(2));
        
        // Update split payment totals
        updateSplitPaymentTotals(grandTotal);
    }
    
    // Split payment functionality
    function updateSplitPaymentTotals(grandTotal) {
        var cashAmount = parseFloat($('input[name="cash_amount"]').val()) || 0;
        var posAmount = parseFloat($('input[name="pos_amount"]').val()) || 0;
        var otherAmount = parseFloat($('input[name="other_amount"]').val()) || 0;
        
        var totalPaid = cashAmount + posAmount + otherAmount;
        var remaining = grandTotal - totalPaid;
        
        $('#split-total').val(totalPaid.toFixed(2));
        $('#split-remaining').val(remaining.toFixed(2));
        
        // Color code the remaining amount
        if (remaining < 0) {
            $('#split-remaining').css('color', 'red');
        } else if (remaining > 0) {
            $('#split-remaining').css('color', 'orange');
        } else {
            $('#split-remaining').css('color', 'green');
        }
    }
    
    // Tax and discount changes
    $('#tax, #discount-value').on('input', updateTotals);
    $('#discount-type').on('change', updateTotals);
    
    // Split payment handling
    $('#payment-mode-select').on('change', function() {
        var paymentMode = $(this).val();
        var $splitDetails = $('#split-details');
        
        if (paymentMode === 'split') {
            $splitDetails.removeClass('d-none');
        } else {
            $splitDetails.addClass('d-none');
            $splitDetails.find('input[type="number"]').val('0.00');
        }
        updateTotals();
    });
    
    // Split payment amount changes
    $('input[name="cash_amount"], input[name="pos_amount"], input[name="other_amount"]').on('input', function() {
        var grandTotal = parseFloat($('#grand-total').val()) || 0;
        updateSplitPaymentTotals(grandTotal);
    });
    
    // Product search functionality
    $(document).on('input', '.product-search-input', function() {
        var $input = $(this);
        var query = $input.val().trim();
        var $row = $input.closest('tr');
        var $results = $row.find('.search-results');
        
        if (query.length < 2) {
            $results.hide();
            return;
        }
        
        if (/^\d{8,}$/.test(query)) {
            lookupProductByBarcode(query, $row);
            return;
        }
        
        $.ajax({
            url: '{% url "portal:product_search_public" %}',
            method: 'GET',
            data: { q: query },
            success: function(response) {
                var $results = $row.find('.search-results');
                $results.empty();
                
                if (response.products && response.products.length > 0) {
                    response.products.forEach(function(product) {
                        var $option = $('<div class="search-result-item">')
                            .css({
                                'padding': '8px',
                                'border-bottom': '1px solid #eee',
                                'cursor': 'pointer',
                                'background': '#f8f9fa'
                            })
                            .hover(function() {
                                $(this).css('background', '#e9ecef');
                            }, function() {
                                $(this).css('background', '#f8f9fa');
                            })
                            .html(product.display_text + '<br><small class="text-muted">' + product.stock_text + '</small>')
                            .data('product', product)
                            .on('click', function() {
                                var selectedProduct = $(this).data('product');
                                selectProduct(selectedProduct, $row);
                                $results.hide();
                            });
                        $results.append($option);
                    });
                    $results.show();
                } else {
                    $results.hide();
                }
            }
        });
    });
    
    // Barcode lookup function
    function lookupProductByBarcode(barcode, $row) {
        $.ajax({
            url: '{% url "portal:barcode_lookup_public" %}',
            method: 'GET',
            data: { barcode: barcode },
            success: function(response) {
                if (response.product) {
                    selectProduct(response.product, $row);
                }
            }
        });
    }
    
    // Select product function
    function selectProduct(product, $row) {
        var $select = $row.find('.product-select');
        var $searchInput = $row.find('.product-search-input');
        
        $select.val(product.id);
        $searchInput.val(product.name);
        $row.find('.unit-price').val(product.unit_price);
        calculateRowTotal($row[0]);
    }
    
    // Hide search results when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.product-search-container').length) {
            $('.search-results').hide();
        }
    });
    
    // Customer modal - simple version
    $('#add-customer-btn').on('click', function() {
        openCustomerModal();
    });
    
    function openCustomerModal() {
        var modalHtml = `
            <div class="modal fade" id="customerModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h5 class="modal-title">Add New Customer</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="customerForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="full_name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Phone <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="phone" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Company Name</label>
                                        <input type="text" class="form-control" name="company_name">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Tax Number</label>
                                        <input type="text" class="form-control" name="tax_number">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <textarea class="form-control" name="address" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveCustomerBtn">Save Customer</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#customerModal').remove();
        $('body').append(modalHtml);
        
        var modal = new bootstrap.Modal(document.getElementById('customerModal'));
        modal.show();
        
        $('#saveCustomerBtn').on('click', function() {
            var formData = new FormData(document.getElementById('customerForm'));
            formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
            
            $.ajax({
                url: '{% url "portal:customer_create" %}',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                success: function(response) {
                    if (response.success) {
                        var customerSelect = $('#customer');
                        var option = new Option(response.customer.display_text || response.customer.name, response.customer.id, true, true);
                        customerSelect.append(option);
                        modal.hide();
                        alert('Customer added successfully!');
                    }
                },
                error: function() {
                    alert('Error creating customer. Please try again.');
                }
            });
        });
    }
    
    // Add first product row
    $('#add-product').trigger('click');
    
    console.log('✅ Simple Invoice Script Loaded Successfully');
});
</script>
{% endblock %}
                    response.products.forEach(function(product) {
                        var $option = $('<div class="search-result-item">')
                            .css({
                                'padding': '8px',
                                'border-bottom': '1px solid #eee',
                                'cursor': 'pointer',
                                'background': '#f8f9fa'
                            })
                            .hover(function() {
                                $(this).css('background', '#e9ecef');
                            }, function() {
                                $(this).css('background', '#f8f9fa');
                            })
                            .html(product.display_text + '<br><small class="text-muted">' + product.stock_text + '</small>')
                            .data('product', product)
                            .on('click', function() {
                                var selectedProduct = $(this).data('product');
                                selectProduct(selectedProduct, $row);
                                $results.hide();
                            });
                        $results.append($option);
                    });
                    $results.show();
                } else {
                    $results.hide();
                }
            },
            error: function(xhr) {
                console.error('❌ Product search error:', xhr);
            }
        });
    });
    
    // Function to select a product
    function selectProduct(product, $row) {
        var $select = $row.find('.product-select');
        var $searchInput = $row.find('.product-search-input');
        
        // Set the select value
        $select.val(product.id);
        
        // Set the search input to show selected product
        $searchInput.val(product.name);
        
        // Set the price
        $row.find('.unit-price').val(product.unit_price);
        
        // Calculate total
        calculateRowTotal($row[0]);
        
        console.log('✅ Product selected:', product.name);
    }
    
    // Hide search results when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.product-search-container').length) {
            $('.search-results').hide();
        }
    });
    
    // Handle quantity changes
    $(document).on('input', '.quantity', function() {
        var $row = $(this).closest('tr');
        calculateRowTotal($row[0]);
    });
    
    // Remove product row
    $(document).on('click', '.remove-product', function() {
        $(this).closest('tr').remove();
        updateTotals();
    });
    
    // Calculate row total
    function calculateRowTotal(row) {
        var quantity = parseFloat($(row).find('.quantity').val()) || 0;
        var unitPrice = parseFloat($(row).find('.unit-price').val()) || 0;
        var total = quantity * unitPrice;
        
        $(row).find('.total').val(total.toFixed(2));
        updateTotals();
    }
    
    // Update grand totals
    function updateTotals() {
        var subtotal = 0;
        $('.total').each(function() {
            subtotal += parseFloat($(this).val()) || 0;
        });
        
        var tax = parseFloat($('#tax').val()) || 0;
        var discountValue = parseFloat($('#discount-value').val()) || 0;
        var discountType = $('#discount-type').val();
        
        var discountAmount = 0;
        if (discountType === 'percent') {
            discountAmount = subtotal * (discountValue / 100);
        } else {
            discountAmount = discountValue;
        }
        
        var grandTotal = subtotal + tax - discountAmount;
        
        $('#subtotal').val(subtotal.toFixed(2));
        $('#discount-amount').val(discountAmount.toFixed(2));
        $('#grand-total').val(grandTotal.toFixed(2));
    }
    
    // Tax and discount changes
    $('#tax, #discount-value').on('input', updateTotals);
    $('#discount-type').on('change', updateTotals);
    
    // Payment mode split toggle
    $('#payment-mode-select').on('change', function() {
        var paymentMode = $(this).val();
        var $splitDetails = $('#split-details');
        
        if (paymentMode === 'split') {
            $splitDetails.removeClass('d-none');
            console.log('✅ Split payment mode enabled');
        } else {
            $splitDetails.addClass('d-none');
            // Clear split amounts when not in split mode
            $splitDetails.find('input[type="number"]').val('0.00');
            console.log('✅ Split payment mode disabled');
        }
    });
    
    // Split payment amount validation
    $('#split-details input[type="number"]').on('input', function() {
        var grandTotal = parseFloat($('#grand-total').val()) || 0;
        var cashAmount = parseFloat($('input[name="cash_amount"]').val()) || 0;
        var posAmount = parseFloat($('input[name="pos_amount"]').val()) || 0;
        var otherAmount = parseFloat($('input[name="other_amount"]').val()) || 0;
        var totalSplit = cashAmount + posAmount + otherAmount;
        
        var $messages = $('#form-messages');
        if (Math.abs(totalSplit - grandTotal) > 0.01) {
            $messages.removeClass('d-none alert-success').addClass('alert-warning')
                .text(`Split total (${totalSplit.toFixed(2)}) must equal grand total (${grandTotal.toFixed(2)})`);
        } else {
            $messages.removeClass('alert-warning').addClass('d-none');
        }
    });
    
    // Form submission handling
    $('#invoice-form').on('submit', function(e) {
        e.preventDefault();
        
        var paymentMode = $('#payment-mode-select').val();
        var grandTotal = parseFloat($('#grand-total').val()) || 0;
        
        // Validate split payment if enabled
        if (paymentMode === 'split') {
            var cashAmount = parseFloat($('input[name="cash_amount"]').val()) || 0;
            var posAmount = parseFloat($('input[name="pos_amount"]').val()) || 0;
            var otherAmount = parseFloat($('input[name="other_amount"]').val()) || 0;
            var totalSplit = cashAmount + posAmount + otherAmount;
            
            if (Math.abs(totalSplit - grandTotal) > 0.01) {
                alert('Split payment amounts must equal the grand total');
                return false;
            }
        }
        
        // Collect form data
        var formData = new FormData(this);
        
        // Collect product items as JSON
        var items = [];
        $('#product-rows tr').each(function() {
            var $row = $(this);
            var productId = $row.find('.product-select').val();
            if (productId) {
                items.push({
                    product: productId,
                    quantity: $row.find('.quantity').val(),
                    unit_price: $row.find('.unit-price').val(),
                    selling_price: $row.find('.unit-price').val()
                });
            }
        });
        
        formData.append('items', JSON.stringify(items));
        
        // Add calculated totals
        formData.append('subtotal', $('#subtotal').val());
        formData.append('tax', $('#tax').val());
        formData.append('discount_type', $('#discount-type').val());
        formData.append('discount_value', $('#discount-value').val());
        formData.append('discount_amount', $('#discount-amount').val());
        formData.append('grand_total', $('#grand-total').val());
        
        // Show loading state
        var $submitBtn = $('button[type="submit"]');
        var originalText = $submitBtn.text();
        $submitBtn.prop('disabled', true).text('Saving...');
        
        // Submit form via AJAX
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                console.log('✅ Invoice saved successfully:', response);
                if (response.success) {
                    showSuccessModal(response);
                } else {
                    alert('Error: ' + (response.message || 'Unknown error occurred'));
                    $submitBtn.prop('disabled', false).text(originalText);
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ Form submission error:', error);
                alert('An error occurred while saving the invoice. Please try again.');
                $submitBtn.prop('disabled', false).text(originalText);
            }
        });
    });
    
    // Success modal display
    function showSuccessModal(data) {
        var modal = `
            <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5); z-index: 9999;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">✅ Invoice Saved Successfully!</h5>
                        </div>
                        <div class="modal-body">
                            <p><strong>Invoice Number:</strong> ${data.invoice_number}</p>
                            <p><strong>Total Amount:</strong> ${data.total_amount || $('#grand-total').val()}</p>
                            <p>What would you like to do next?</p>
                        </div>
                        <div class="modal-footer">
                            <a href="${data.redirect_url}" class="btn btn-primary">View Invoice</a>
                            <a href="${data.redirect_url.replace('/detail/', '/pdf/')}" target="_blank" class="btn btn-info">Download PDF</a>
                            <button type="button" class="btn btn-success" onclick="printInvoice('${data.redirect_url.replace('/detail/', '/pdf/')}')">Print Invoice</button>
                            <a href="{% url 'portal:invoice_list' %}" class="btn btn-secondary">Invoice List</a>
                            <button type="button" class="btn btn-outline-success" onclick="location.reload()">Create Another</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('body').append(modal);
        
        // Auto redirect to invoice detail after 10 seconds
        setTimeout(function() {
            window.location.href = data.redirect_url;
        }, 10000);
    }
    
    // Print invoice function
    window.printInvoice = function(pdfUrl) {
        var printWindow = window.open(pdfUrl, '_blank');
        if (printWindow) {
            printWindow.onload = function() {
                printWindow.print();
            };
        } else {
            alert('Please allow popups to print the invoice');
        }
    };
    
    // Enhanced Customer Creation Modal Handler
    $('#add-customer-btn').on('click', function() {
        console.log('🖱️ Add Customer clicked - Enhanced approach');
        openCustomerModal();
    });
    
    // Enhanced error handling and success feedback
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Remove existing alerts
        $('.alert').remove();
        
        // Add alert to the top of the form
        $('.card-body').first().prepend(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
        
        // Scroll to top to show alert
        $('html, body').animate({ scrollTop: 0 }, 500);
    }
    
    // Add first product row automatically
    setTimeout(function() {
        $('#add-product').trigger('click');
    }, 500);
    
    console.log('✅ Enhanced Invoice Script Loaded Successfully');
});

// Enhanced Customer Creation Modal Functions
function openCustomerModal() {
    console.log('📝 Opening enhanced customer modal...');
    
    const modalHtml = `
        <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="modal-title" id="customerModalLabel">
                            <i class="fas fa-user-plus me-2"></i>Add New Customer
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="customer-form-alerts"></div>
                        <form id="customerForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="full_name" class="form-label fw-bold">
                                        <i class="fas fa-user me-1"></i>Full Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="full_name" name="full_name" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label fw-bold">
                                        <i class="fas fa-phone me-1"></i>Phone <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="phone" name="phone" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="company_name" class="form-label fw-bold">
                                        <i class="fas fa-building me-1"></i>Company Name
                                    </label>
                                    <input type="text" class="form-control" id="company_name" name="company_name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tax_number" class="form-label fw-bold">
                                        <i class="fas fa-receipt me-1"></i>Tax Number
                                    </label>
                                    <input type="text" class="form-control" id="tax_number" name="tax_number">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="address" class="form-label fw-bold">
                                        <i class="fas fa-map-marker-alt me-1"></i>Address
                                    </label>
                                    <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="preferred_contact_method" class="form-label fw-bold">
                                        <i class="fas fa-envelope me-1"></i>Contact Method
                                    </label>
                                    <select class="form-control" id="preferred_contact_method" name="preferred_contact_method">
                                        <option value="">Select...</option>
                                        <option value="phone">Phone</option>
                                        <option value="email">Email</option>
                                        <option value="whatsapp">WhatsApp</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="saveCustomerBtn">
                            <i class="fas fa-save me-1"></i>Save Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    $('#customerModal').remove();
    
    // Add modal to DOM
    $('body').append(modalHtml);
    
    // Show modal with proper Bootstrap handling
    let modal;
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        modal = new bootstrap.Modal(document.getElementById('customerModal'));
        modal.show();
    } else {
        // Fallback for jQuery modal
        $('#customerModal').modal('show');
    }
    
    // Handle form submission
    $('#saveCustomerBtn').off('click').on('click', function() {
        const btn = $(this);
        const originalText = btn.html();
        
        // Show loading state
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Saving...').prop('disabled', true);
        
        saveCustomer().finally(() => {
            // Restore button state
            btn.html(originalText).prop('disabled', false);
        });
    });
}

function saveCustomer() {
    return new Promise((resolve, reject) => {
        const form = document.getElementById('customerForm');
        const formData = new FormData(form);
        
        // Add CSRF token
        const csrfToken = $('[name=csrfmiddlewaretoken]').val();
        if (!csrfToken) {
            showCustomerAlert('danger', 'Security token missing. Please reload the page.');
            reject('CSRF token missing');
            return;
        }
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Clear previous errors
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').text('');
        $('#customer-form-alerts').empty();
        
        console.log('📤 Sending customer data...');
        
        $.ajax({
            url: '{% url "portal:customer_create" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('✅ Customer created successfully:', response);
                
                if (response.success && response.customer) {
                    // Add customer to dropdown
                    const customerSelect = $('#customer');
                    const displayText = response.customer.display_text || 
                                      `${response.customer.name} - ${response.customer.phone}`;
                    
                    const option = new Option(displayText, response.customer.id, true, true);
                    customerSelect.append(option);
                    customerSelect.val(response.customer.id).trigger('change');
                    
                    // Close modal
                    const modalElement = document.getElementById('customerModal');
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) modalInstance.hide();
                    } else {
                        $('#customerModal').modal('hide');
                    }
                    
                    // Show success message
                    showAlert('success', `Customer "${response.customer.name}" added successfully!`);
                    resolve(response);
                } else {
                    showCustomerAlert('danger', 'Unexpected response format from server.');
                    reject('Invalid response format');
                }
            },
            error: function(xhr) {
                console.error('❌ Customer creation failed:', xhr);
                
                if (xhr.responseJSON && xhr.responseJSON.errors) {
                    // Show field errors
                    let hasErrors = false;
                    Object.keys(xhr.responseJSON.errors).forEach(function(field) {
                        const fieldElement = $(`#${field}`);
                        if (fieldElement.length) {
                            fieldElement.addClass('is-invalid');
                            fieldElement.siblings('.invalid-feedback').text(xhr.responseJSON.errors[field][0]);
                            hasErrors = true;
                        }
                    });
                    
                    if (!hasErrors) {
                        showCustomerAlert('danger', 'Please check your input and try again.');
                    }
                } else if (xhr.status === 403) {
                    showCustomerAlert('danger', 'Permission denied. Please check your login status.');
                } else if (xhr.status === 404) {
                    showCustomerAlert('danger', 'Customer creation endpoint not found. Please contact support.');
                } else {
                    showCustomerAlert('danger', 'Failed to create customer. Please try again.');
                }
                reject(xhr);
            }
        });
    });
}

function showCustomerAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('#customer-form-alerts').html(alertHtml);
}
</script>
{% endblock %}
