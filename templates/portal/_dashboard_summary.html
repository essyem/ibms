{% load humanize %}

<!-- Partial: dashboard summary cards and tables (rendered asynchronously) -->
<div class="dashboard-summary-content">
    <div class="grid mb-4">
        <div class="card">
            <h3>Total Customers</h3>
            <p>{{ total_customers|intcomma }}</p>
            <a href="{% url 'admin:portal_customer_changelist' %}" class="view-all">View All</a>
        </div>
        <div class="card">
            <h3>Pending Invoices</h3>
            <p>{{ pending_invoices|intcomma }}</p>
            <a href="{% url 'admin:portal_invoice_changelist' %}?status__exact=pending" class="view-all">View Pending</a>
        </div>
        <div class="card">
            <h3>Monthly Revenue</h3>
            <p>QAR {{ monthly_revenue|floatformat:2|intcomma }}</p>
            <a href="{% url 'admin:portal_invoice_changelist' %}?status__exact=paid" class="view-all">View Paid</a>
        </div>
        <div class="card">
            <h3>Active Products</h3>
            <p>{{ active_products|intcomma }}</p>
            <a href="{% url 'admin:portal_product_changelist' %}" class="view-all">View All</a>
        </div>
    </div>

    <h2>ðŸ“¦ Product Analytics</h2>
    <div class="grid mb-4">
        <div class="card">
            <h3>Total Inventory Value (Cost)</h3>
            <p>QAR {{ total_inventory_cost_value|floatformat:2|intcomma }}</p>
            <small>Based on cost price Ã— stock</small>
        </div>
        <div class="card">
            <h3>Total Inventory Value (Selling)</h3>
            <p>QAR {{ total_inventory_value|floatformat:2|intcomma }}</p>
            <small>Based on selling price Ã— stock</small>
        </div>
        <div class="card">
            <h3>Potential Profit</h3>
            <p>QAR {{ potential_profit|floatformat:2|intcomma }}</p>
            <small>Selling value - Cost value</small>
        </div>
        <div class="card">
            <h3>Average Cost Price</h3>
            <p>QAR {{ avg_cost_price|floatformat:2|intcomma }}</p>
            <small>Average cost per product</small>
        </div>
    </div>

    <h2>ðŸ›’ Procurement Analytics</h2>
    <div class="grid mb-4">
        <div class="card">
            <h3>Total Purchase Orders</h3>
            <p>{{ total_purchase_orders|intcomma }}</p>
            <a href="{% url 'admin:procurement_purchaseorder_changelist' %}" class="view-all">View All</a>
        </div>
        <div class="card">
            <h3>Total Procurement Value</h3>
            <p>QAR {{ total_procurement_value|floatformat:2|intcomma }}</p>
            <small>All purchase orders total</small>
        </div>
        <div class="card">
            <h3>This Month's Purchases</h3>
            <p>QAR {{ monthly_procurement|floatformat:2|intcomma }}</p>
            <small>Current month procurement</small>
        </div>
        <div class="card">
            <h3>Average Order Value</h3>
            <p>QAR {{ avg_order_value|floatformat:2|intcomma }}</p>
            <small>Average purchase order size</small>
        </div>
    </div>

    {% if products_by_category %}
    <h2>ðŸ“Š Products by Category</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Product Count</th>
                    <th>Total Cost Value</th>
                    <th>Total Selling Value</th>
                    <th>Potential Profit</th>
                    <th>Profit Margin</th>
                </tr>
            </thead>
            <tbody>
                {% for category in products_by_category %}
                <tr>
                    <td>{{ category.category__name|default:"Uncategorized" }}</td>
                    <td>{{ category.count|intcomma }}</td>
                    <td>QAR {{ category.total_cost_value|floatformat:2|intcomma|default:"0.00" }}</td>
                    <td>QAR {{ category.total_value|floatformat:2|intcomma|default:"0.00" }}</td>
                    <td>QAR {{ category.profit|floatformat:2|intcomma|default:"0.00" }}</td>
                    <td>{{ category.profit_margin|floatformat:1|default:"0.0" }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if high_value_products %}
    <h2>ðŸ’Ž High Value Products (Top 10)</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Cost Price</th>
                    <th>Selling Price</th>
                    <th>Profit per Unit</th>
                    <th>Stock</th>
                    <th>Total Cost Value</th>
                    <th>Total Selling Value</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in high_value_products %}
                <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ product.category.name|default:"N/A" }}</td>
                    <td>QAR {{ product.cost_price|floatformat:2|intcomma }}</td>
                    <td>QAR {{ product.unit_price|floatformat:2|intcomma }}</td>
                    <td>QAR {{ product.profit_per_unit|floatformat:2|intcomma }}</td>
                    <td>{{ product.stock|intcomma }}</td>
                    <td>QAR {{ product.total_cost_value|floatformat:2|intcomma }}</td>
                    <td>QAR {{ product.total_selling_value|floatformat:2|intcomma }}</td>
                    <td>
                        <a href="{% url 'admin:portal_product_change' product.id %}" class="button small">Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
