{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load i18n %}
{% load cart_filters %}

{% block title %}سلة التسوق - TrendzApps{% endblock %}

{% block extra_css %}
<style>
html, body { direction: rtl; }
.cart-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

/* Keep most styles from cart.html but adapt alignment for RTL */
.cart-item-card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 12px; margin-bottom: 1rem; }
.product-image { width: 100px; height: 100px; background: linear-gradient(45deg,#f8f9fa,#e9ecef); border-radius: 8px; display:flex; align-items:center; justify-content:center; }
.quantity-controls { display:flex; align-items:center; gap:10px; justify-content:center; }
.quantity-btn { width:35px; height:35px; border-radius:50%; border:2px solid #28a745; background:white; color:#28a745; display:flex; align-items:center; justify-content:center; }
.quantity-input { width:60px; text-align:center; border:2px solid #e9ecef; border-radius:8px; padding:8px; }
.cart-summary { background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:2rem; position:sticky; top:20px; }
.checkout-btn { background:linear-gradient(135deg,#28a745,#20c997); border:none; color:white; padding:1rem 2rem; border-radius:25px; width:100%; }
.whatsapp-btn { background:#25d366; border:none; color:white; padding:0.75rem 1.5rem; border-radius:25px; width:100%; margin-top:1rem; }
.continue-shopping-btn { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border:none; color:white; padding:0.75rem 1.5rem; border-radius:25px; }
.remove-item-btn { background:#dc3545; border:none; color:white; padding:0.5rem 1rem; border-radius:20px; }
.empty-cart { text-align:center; padding:4rem 2rem; color:#6c757d; }

@media (max-width:768px){ .product-image{ width:80px; height:80px; } }
</style>
{% endblock %}

{% block content %}
<div class="cart-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2"><i class="fas fa-shopping-cart me-2"></i>سلة التسوق</h1>
                <p class="mb-0">راجع العناصر التي اخترتها وأكمل عملية الدفع</p>
            </div>
            <div class="col-md-4 text-md-start">
                <div class="h4 mb-0">
                    {% blocktrans count total=total_items %}
                        {{ total|intcomma }} عنصر
                    {% plural %}
                        {{ total|intcomma }} عناصر
                    {% endblocktrans %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    {% if cart_items %}
    <div class="row">
        <div class="col-lg-8">
            {% for item in cart_items %}
            <div class="cart-item-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2 col-3 text-center">
                            <div class="product-image">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="col-md-4 col-9 text-end">
                            <h6 class="mb-1">{{ item.product.name }}</h6>
                            <p class="text-muted small mb-1">رمز المنتج: {{ item.product.sku }}</p>
                            {% if item.product.category %}
                                <p class="text-muted small mb-1">الفئة: {{ item.product.category.name }}</p>
                            {% endif %}
                            <p class="text-success small mb-0"><i class="fas fa-check-circle me-1"></i>متاح ({{ item.product.stock }} متوفر)</p>
                        </div>
                        <div class="col-md-3 col-6 text-center">
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateQuantity({{ item.id }}, {{ item.quantity }} - 1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" onchange="updateQuantity({{ item.id }}, this.value)">
                                <button class="quantity-btn" onclick="updateQuantity({{ item.id }}, {{ item.quantity }} + 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 text-center">
                            <div class="h6 text-danger mb-2" id="item-total-{{ item.id }}">QAR {{ item.quantity|mul:item.product.unit_price|floatformat:2 }}</div>
                            <div class="small text-muted mb-2">QAR {{ item.product.unit_price|floatformat:2 }} لكل وحدة</div>
                            <button class="remove-item-btn" onclick="removeItem({{ item.id }})"><i class="fas fa-trash me-1"></i>إزالة</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="text-center mt-4">
                <a href="{% url 'portal:public_catalog' %}" class="continue-shopping-btn"><i class="fas fa-arrow-right me-2"></i>متابعة التسوق</a>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="cart-summary text-end">
                <h5 class="mb-4"><i class="fas fa-receipt me-2"></i>ملخص الطلب</h5>
                <div class="d-flex justify-content-between mb-3">
                    <span>العناصر ({{ total_items }})</span>
                    <span id="cart-subtotal">QAR {{ total_amount|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>التوصيل</span>
                    <span class="text-success">مجاني</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-4">
                    <strong>الإجمالي</strong>
                    <strong class="text-danger" id="cart-total">QAR {{ total_amount|floatformat:2 }}</strong>
                </div>
                <a href="{% url 'portal:checkout' %}" class="checkout-btn"><i class="fas fa-credit-card me-2"></i>المتابعة للدفع</a>
                <a href="https://wa.me/{{ whatsapp_number|cut:'+' }}?text=مرحبًا! لدي عناصر في السلة وأرغب في الطلب." target="_blank" class="whatsapp-btn"><i class="fab fa-whatsapp me-2"></i>اطلب عبر واتساب</a>
                <div class="text-center mt-3"><small class="text-muted"><i class="fas fa-shield-alt me-1"></i>دفع آمن مع حماية المشتري 100%</small></div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <i class="fas fa-shopping-cart"></i>
        <h3>سلة التسوق فارغة</h3>
        <p>يبدو أنك لم تضف أي عناصر إلى سلة التسوق بعد.</p>
        <a href="{% url 'portal:public_catalog' %}" class="btn btn-primary btn-lg"><i class="fas fa-store me-2"></i>ابدأ التسوق</a>
    </div>
    {% endif %}
</div>

<!-- Toast for cart updates (reuse existing) -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="cart-update-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-shopping-cart me-2"></i>
            <strong class="me-auto">تم تحديث السلة</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="cart-update-message">تم تحديث السلة بنجاح!</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) {
        if (confirm('هل تريد إزالة هذا المنتج من السلة؟')) { removeItem(itemId); }
        return;
    }
    fetch('{% url "portal:update_cart_item" %}', {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
        body: JSON.stringify({ item_id: itemId, quantity: newQuantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`item-total-${itemId}`).textContent = `QAR ${data.item_total_price.toFixed(2)}`;
            document.getElementById('cart-subtotal').textContent = `QAR ${data.cart_total_amount.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `QAR ${data.cart_total_amount.toFixed(2)}`;
            updateCartCounter(); showToast(data.message);
        } else { alert(data.message); }
    })
    .catch(err => { console.error(err); alert('حدث خطأ أثناء تحديث السلة'); });
}
function removeItem(itemId) {
    if (!confirm('هل أنت متأكد أنك تريد إزالة هذا العنصر؟')) return;
    fetch('{% url "portal:remove_from_cart" %}', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }, body: JSON.stringify({ item_id: itemId }) })
    .then(response => response.json()).then(data => { if (data.success) location.reload(); else alert(data.message); }).catch(err => { console.error(err); alert('حدث خطأ أثناء إزالة العنصر'); });
}
function updateCartCounter() { fetch('{% url "portal:cart_count" %}').then(res => res.json()).then(data => { const cartCounter = document.getElementById('cart-counter'); if (cartCounter) { cartCounter.textContent = data.cart_total_items; cartCounter.style.display = data.cart_total_items > 0 ? 'block' : 'none'; } }); }
function showToast(message) { document.getElementById('cart-update-message').textContent = message; const toast = new bootstrap.Toast(document.getElementById('cart-update-toast')); toast.show(); }
document.addEventListener('DOMContentLoaded', function() { if (!document.querySelector('[name=csrfmiddlewaretoken]')) { const csrfInput = document.createElement('input'); csrfInput.type = 'hidden'; csrfInput.name = 'csrfmiddlewaretoken'; csrfInput.value = '{{ csrf_token }}'; document.body.appendChild(csrfInput); } });
</script>
{% endblock %}