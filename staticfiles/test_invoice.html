<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Invoice Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Invoice Function Test Page</h2>
        
        <!-- Customer Section Test -->
        <div class="card mb-3">
            <div class="card-header">Customer Test</div>
            <div class="card-body">
                <div class="input-group">
                    <select class="form-control" id="customer">
                        <option value="">Select Customer</option>
                        <option value="1">Test Customer 1</option>
                        <option value="2">Test Customer 2</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" id="add-customer-btn" title="Add New Customer">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Products Section Test -->
        <div class="card mb-3">
            <div class="card-header">Products Test</div>
            <div class="card-body">
                <table class="table" id="products-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="product-rows">
                        <!-- Product rows will be added here -->
                    </tbody>
                </table>
                
                <button type="button" class="btn btn-primary" id="add-product">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
        </div>
        
        <!-- Hidden inputs for testing -->
        <input type="hidden" name="csrfmiddlewaretoken" value="test-token">
        
        <!-- Totals for testing -->
        <div class="row">
            <div class="col-md-6">
                <label>Subtotal:</label>
                <input type="text" class="form-control" id="subtotal" value="0.00" readonly>
            </div>
            <div class="col-md-6">
                <label>Tax:</label>
                <input type="number" class="form-control" id="tax" value="0.00">
            </div>
        </div>
    </div>
    
    <!-- Product Row Template -->
    <template id="product-row-template">
        <tr class="product-row">
            <td>
                <select class="form-control product-select" name="products">
                    <option value="">Select a product...</option>
                    <option value="1" data-selling-price="35.00" data-unit-price="35.00">Test Product 1 - QAR 35.00</option>
                    <option value="2" data-selling-price="160.00" data-unit-price="160.00">Test Product 2 - QAR 160.00</option>
                </select>
            </td>
            <td>
                <input type="number" class="form-control quantity" name="quantity" value="1" min="1" step="1" required>
            </td>
            <td>
                <input type="text" class="form-control unit-price" name="unit_price" value="0.00" readonly>
            </td>
            <td>
                <input type="text" class="form-control total" name="total" value="0.00" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger remove-product">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    </template>

<script>
// FIXED INVOICE SCRIPT - Test Version
$(document).ready(function() {
    console.log('üöÄ Test Invoice Script Starting...');
    
    // Define updateTotals function first
    window.updateTotals = function() {
        var subtotal = 0;
        $('.total').each(function() {
            var value = parseFloat($(this).val()) || 0;
            subtotal += value;
        });
        
        var tax = parseFloat($('#tax').val()) || 0;
        var grandTotal = subtotal + tax;
        
        $('#subtotal').val(subtotal.toFixed(2));
        
        console.log('üí∞ Totals updated - Subtotal:', subtotal, 'Grand Total:', grandTotal);
    };
    
    // Define calculateRowTotal function
    window.calculateRowTotal = function(row) {
        var $row = $(row);
        var quantity = parseFloat($row.find('.quantity').val()) || 0;
        var unitPrice = parseFloat($row.find('.unit-price').val()) || 0;
        var total = quantity * unitPrice;
        
        $row.find('.total').val(total.toFixed(2));
        updateTotals();
        
        console.log('üßÆ Row total calculated:', total);
    };
    
    // Fixed Add Product functionality
    $('#add-product').on('click', function(e) {
        e.preventDefault();
        console.log('üñ±Ô∏è Add Product clicked - Test approach');
        
        // Get the template content
        var template = document.getElementById('product-row-template');
        if (!template) {
            console.error('‚ùå Template not found');
            return;
        }
        
        // Clone the template - Handle both HTML5 template and fallback
        var clone;
        if (template.content) {
            // Modern browsers with HTML5 template support
            clone = document.importNode(template.content, true);
        } else {
            // Fallback for older browsers
            clone = $(template.innerHTML)[0];
        }
        
        // Add to product rows
        var productRows = document.getElementById('product-rows');
        if (productRows) {
            productRows.appendChild(clone);
            console.log('‚úÖ Product row added successfully');
            updateTotals();
        } else {
            console.error('‚ùå Product rows container not found');
        }
    });
    
    // Handle product selection - Fixed
    $(document).on('change', '.product-select', function() {
        var $select = $(this);
        var $row = $select.closest('tr');
        var selectedOption = $select.find('option:selected');
        
        if (selectedOption.val()) {
            var unitPrice = selectedOption.data('selling-price') || selectedOption.data('unit-price') || 0;
            
            console.log('‚úÖ Product selected:', {
                id: selectedOption.val(),
                name: selectedOption.text(),
                unitPrice: unitPrice
            });
            
            $row.find('.unit-price').val(parseFloat(unitPrice).toFixed(2));
            calculateRowTotal($row[0]);
        } else {
            $row.find('.unit-price').val('0.00');
            $row.find('.total').val('0.00');
            updateTotals();
        }
    });
    
    // Handle quantity changes - Fixed
    $(document).on('input change', '.quantity', function() {
        var $row = $(this).closest('tr');
        calculateRowTotal($row[0]);
    });
    
    // Remove product row - Fixed
    $(document).on('click', '.remove-product', function(e) {
        e.preventDefault();
        $(this).closest('tr').remove();
        updateTotals();
        console.log('üóëÔ∏è Product row removed');
    });
    
    // Customer Creation Modal Handler - Fixed
    $('#add-customer-btn').on('click', function(e) {
        e.preventDefault();
        console.log('üë§ Add Customer button clicked');
        alert('Customer modal would open here!\n\nThis confirms the button is working properly.');
    });
    
    // Add first row automatically - Fixed with delay
    setTimeout(function() {
        $('#add-product').trigger('click');
        console.log('üöÄ First product row added automatically');
    }, 100);
    
    console.log('‚úÖ Test Invoice Script Loaded Successfully');
});
</script>

</body>
</html>
